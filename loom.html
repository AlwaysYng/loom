<!DOCTYPE html>
<html lang="en">
	{%
		local _ft_, _fndx_ = {}, 0
		local function funclabel(f)
			if _ft_[f] == nil then
				_fndx_ = _fndx_+1
				_ft_[f] = ('fn%03d'):format(_fndx_)
			end
			return _ft_[f]
		end
		local annotated = utils.annotated(funcs, traces)
	%}
	<head>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<style media="screen" type="text/css">
			.code {
				font-family: monospace;
				white-space: pre;
				tab-size: 4;
			}
			.bordertop td {
				border-top: thin black solid;
			}
			.phantom {
				color: #ccc	;
			}
			.white {
				background-color: white;
			}
			.popup {
/* 				display: none; */
/* 				position: absolute; */
			}
			{% for i = 1, #funcs do %}{{:'.fn%03d', i}} {
				background-color: hsla({{math.random(360)}}, 80%, 85%, 1);
			}
			{% end %}

			{% for i = 1, #traces do %}{{:'.tr%03d', i}} {
				background-color: hsla({{math.random(360)}}, 80%, 75%, 1);
			}
			{% end %}
		</style>
		<script type="text/javascript">
			"use strict";
// 			{
// 				function bitRev (n) {
// 					let i = 0, reversed = 0, last;
// 					while (i < 15) {
// 						last = n & 1;
// 						n >>= 1;
// 						reversed += last;
// 						reversed <<= 1;
// 						i++;
// 					}
// 					return reversed;
// 				}
// 				let nxtcol = 0;
// 				var col = function () {
// 					return 'hsla('+bitRev(++nxtcol)*360/65536+', 80%, 75%, 1)';
// 				}
// 			}

			$(function() {
// 				var body = $('body');
// 				var tracenames = ['tr001', 'tr002'];
// 				for (let tn of tracenames) {
// 					let rule = '<style>.'+tn+' { background-color: '+col()+'; }</style>';
// 					$(rule).appendTo('head');
//
// // 					$('.'+tn).mouseenter(function (e){
// // 						let target = $(e.target);
// // 						let popup = $('#'+tn);
// // 						let pos = target.offset();
// // 						pos.top += target.height()*1.5;
// // 						pos.left += target.width()/2 - popup.width()/4;
// // 						popup.show().offset(pos);
// // 					}).mouseleave(function (e){
// // 						$('#'+tn).hide();
// // 					})
// 				}
			});
		</script>
	</head>
	<body>
	{% for filename, filedata in pairs(annotated) do
		local lastline
		%}
		<table class="code">
			<tr>
				<th colspan="2">{{ filename }}</th>
				<th colspan="3">Bytecode</th>
			</th>
			{% for i, l in utils.sortedpairs(filedata) do
				local notsame = l.i ~= lastline
				lastline = l.i
				%}
			<tr {{= utils.class{bordertop=notsame and l.bc ~= ''} }}>
				<td {{= utils.class{phantom=l.back} }}>{{ notsame and l.i or '' }}</td>
				<td {{= utils.class{phantom=l.back} }}>{{ notsame and l.src or '' }}</td>
				<td {{= utils.class{[funclabel(l.func)] = l.bc ~= ''} }}>{{ l.bc }}</td>
				<td>{% for i, tr in ipairs(l.tr) do %} <span
						id="{{:'tr%03d_%03d', tr[1], tr[2]}}"
						class="{{:'tr%03d', tr[1]}}"
					>{{tr[1]}}/{{tr[2]}}</span> {%
				end %}</td>
			</tr>
			{% end %}
		</table>
	{% end %}

	{% for i, tr in ipairs(traces) do %}
		<table class="popup trace {{:'tr%03d', i}}" id="{{:'tr%03d', i}}" cellpadding="4">
			<tr>
				<th colspan="3">Trace #{{i}}: {{tr.tracelabel}}</th>
			</tr>
			<tr class="white">
				<th>bytecode</th>
				<th>IR</th>
				<th>mcode</th>
			</tr>
			<tr class="white" valign="top">
				<td class="code bc">{{utils.tracerecord(tr)}}</td>
				<td class="code ir">{{tr.ir}}</td>
				<td class="code mcode">{{tr.mcode}}</td>
			</tr>
		</table>
	{% end %}
	</body>
</html>
